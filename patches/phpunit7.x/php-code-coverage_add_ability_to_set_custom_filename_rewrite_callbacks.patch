From 6657f34b754b9355295ca5e8297224cc88b460d3 Mon Sep 17 00:00:00 2001
From: Oleg Efimov <o.efimov@corp.badoo.com>
Date: Mon, 22 Apr 2019 17:27:00 +0300
Subject: [PATCH] Add ability to set custom filename rewrite callbacks

---
 src/CodeCoverage.php | 12 +++++++++++-
 src/Filter.php       |  6 ++++++
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/src/CodeCoverage.php b/src/CodeCoverage.php
index 67ba403..16581be 100644
--- a/src/CodeCoverage.php
+++ b/src/CodeCoverage.php
@@ -195,7 +195,17 @@ public function getData(bool $raw = false): array
             $this->addUncoveredFilesFromWhitelist();
         }

-        return $this->data;
+        $data = [];
+        if ($restoreCallback = \PHPUnit\Util\Fileloader::getFilenameRestoreCallback()) {
+            foreach ($this->data as $file => $lines) {
+                    $file = $restoreCallback($file);
+                    $data[$file] = $lines;
+                }
+        } else {
+            $data = $this->data;
+        }
+
+        return $data;
     }

     /**
diff --git a/src/Filter.php b/src/Filter.php
index 631e22c..c0e249a 100644
--- a/src/Filter.php
+++ b/src/Filter.php
@@ -48,6 +48,9 @@ public function addDirectoryToWhitelist(string $directory, string $suffix = '.ph
      */
     public function addFileToWhitelist(string $filename): void
     {
+        if ($rewriteCallback = \PHPUnit\Util\Fileloader::getFilenameRewriteCallback()) {
+            $filename = $rewriteCallback($filename);
+        }
         $this->whitelistedFiles[\realpath($filename)] = true;
     }

@@ -81,6 +84,9 @@ public function removeDirectoryFromWhitelist(string $directory, string $suffix =
      */
     public function removeFileFromWhitelist(string $filename): void
     {
+        if ($rewriteCallback = \PHPUnit\Util\Fileloader::getFilenameRewriteCallback()) {
+            $filename = $rewriteCallback($filename);
+        }
         $filename = \realpath($filename);

         unset($this->whitelistedFiles[$filename]);
--
2.21.0

